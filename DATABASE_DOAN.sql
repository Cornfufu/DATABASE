
BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE PHANCONG CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN
      RAISE; 
      END IF;
END;
/ 
CREATE TABLE PHANCONG(
    MANV VARCHAR(4),
    MADA VARCHAR(4),
    THOIGIAN DATE,
    CONSTRAINT PK_PHANCONG PRIMARY KEY (MANV, MADA)
    );
--Khoa ngoai MADA 


BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE DEAN CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN
      RAISE; 
      END IF;
END;
/    
CREATE TABLE DEAN(
    MADA VARCHAR(4),
    TENDA VARCHAR2(20),
    NGAYBD DATE,
    PHONG VARCHAR(4),
    CONSTRAINT PK_DEAN PRIMARY KEY (MADA)
    );
--Khoa Phong 

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE PHONGBAN CASCADE CONSTRAINTS ';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN
      RAISE; 
      END IF;
END;
/ 
CREATE TABLE PHONGBAN(
    MAPB VARCHAR(4),
    TENPB VARCHAR2(20),
    TRPHG VARCHAR(4),
    CONSTRAINT PK_PHONGBAN PRIMARY KEY (MAPB)
    );
--Khoa ngo?i TRPHG



BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE NHANVIEN CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN
      RAISE; 
      END IF;
END;
/ 
CREATE TABLE NHANVIEN(
    MANV VARCHAR(4),
    TENNV VARCHAR2(50),
    PHAI VARCHAR2(5),
    NGAYSINH DATE,
    DIACHI VARCHAR2(30),
    SODT VARCHAR(12),
    LUONG VARCHAR2(2000),
    PHUCAP VARCHAR2(2000),
    VAITRO VARCHAR2(20),
    MANQL VARCHAR(4),
    PHG VARCHAR(4) NULL, 
    CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANV) -- Tao khoa chinh
);
-- Khoa ngoai MANQL , PHG


--KHOA NGOAI NHANVIEN
ALTER TABLE NHANVIEN
ADD CONSTRAINT FK_MANQL_MANV
FOREIGN KEY (MANQL)
REFERENCES NHANVIEN(MANV)
ON DELETE CASCADE;

ALTER TABLE NHANVIEN
ADD CONSTRAINT FK_PHG_MAPB
FOREIGN KEY (PHG)
REFERENCES PHONGBAN(MAPB)
ON DELETE CASCADE;

--KHOA NGOAI TRPHG
ALTER TABLE PHONGBAN
ADD CONSTRAINT FK_TRPHG_MANV
FOREIGN KEY (TRPHG)
REFERENCES NHANVIEN(MANV)
ON DELETE CASCADE;

--KHOA NGOAI DEAN
ALTER TABLE DEAN 
ADD CONSTRAINT FK_PHONG_MAPB
FOREIGN KEY (PHONG) 
REFERENCES PHONGBAN(MAPB)
ON DELETE CASCADE;

--KHOA PHANCONG
ALTER TABLE PHANCONG
ADD CONSTRAINT FK_MANV_PHANCONG
FOREIGN KEY(MANV)
REFERENCES NHANVIEN(MANV)
ON DELETE CASCADE;

ALTER TABLE PHANCONG
ADD CONSTRAINT FK_MADA_PHANCONG
FOREIGN KEY(MADA)
REFERENCES DEAN(MADA)
ON DELETE CASCADE;

-----------------------------------------------------
BEGIN
   EXECUTE IMMEDIATE 'DROP ROLE NHANSU';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -1919 THEN
      RAISE; 
      END IF;
END;
/
CREATE ROLE NHANSU;

BEGIN
   EXECUTE IMMEDIATE 'DROP ROLE NHANVIEN';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -1919 THEN
      RAISE; 
      END IF;
END;
/
CREATE ROLE NHANVIEN;

BEGIN
   EXECUTE IMMEDIATE 'DROP ROLE GIAMDOC';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -1919 THEN
      RAISE; 
      END IF;
END;
/
CREATE ROLE GIAMDOC;

BEGIN
   EXECUTE IMMEDIATE 'DROP ROLE QUANLY';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -1919 THEN
      RAISE; 
      END IF;
END;
/
CREATE ROLE QUANLY;

BEGIN
   EXECUTE IMMEDIATE 'DROP ROLE TRUONGPHONG';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -1919 THEN
      RAISE; 
      END IF;
END;
/
CREATE ROLE TRUONGPHONG;

BEGIN
   EXECUTE IMMEDIATE 'DROP ROLE TAICHINH';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -1919 THEN
      RAISE; 
      END IF;
END;
/
CREATE ROLE TAICHINH;

BEGIN
   EXECUTE IMMEDIATE 'DROP ROLE TRUONGDA';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -1919 THEN
      RAISE; 
      END IF;
END;
/
CREATE ROLE TRUONGDA;

/
BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE TAIKHOAN_PH2 CASCADE CONSTRAINTS ';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN
      RAISE; 
      END IF;
END;
/ 
CREATE TABLE TAIKHOAN_PH2(
    MATK VARCHAR(4),
    TENTK VARCHAR2(20),
    PASS VARCHAR(50),
    CONSTRAINT PK_MATK PRIMARY KEY (MATK)
);
/


BEGIN
   EXECUTE IMMEDIATE 'DROP PROCEDURE CREATE_USER';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -4043 THEN
      RAISE; 
      END IF;
END;
/
CREATE OR REPLACE PROCEDURE CREATE_USER (MANV VARCHAR2)   
IS 
BEGIN
    BEGIN
       EXECUTE IMMEDIATE 'DROP USER ' || MANV || ' CASCADE';
    EXCEPTION
       WHEN OTHERS THEN
          IF SQLCODE != -1918 THEN
          RAISE; 
          END IF;
    END;
        
        EXECUTE IMMEDIATE 'CREATE USER ' ||  MANV || ' IDENTIFIED BY PH123';
        EXECUTE IMMEDIATE 'GRANT CREATE SESSION TO ' || MANV ;
        EXECUTE IMMEDIATE 'GRANT CONNECT TO ' || MANV ;
        
        IF MANV LIKE 'NV%' THEN 
        EXECUTE IMMEDIATE 'GRANT NHANVIEN TO ' || MANV;
        ELSIF MANV LIKE 'NS%' THEN 
        EXECUTE IMMEDIATE 'GRANT NHANSU TO ' || MANV;
        ELSIF MANV LIKE 'GD%' THEN 
        EXECUTE IMMEDIATE 'GRANT GIAMDOC TO ' || MANV;
        ELSIF MANV LIKE 'TDA%' THEN 
        EXECUTE IMMEDIATE 'GRANT TRUONGDA TO ' || MANV;
        ELSIF MANV LIKE 'TC%' THEN 
        EXECUTE IMMEDIATE 'GRANT TAICHINH TO ' || MANV;
        ELSIF MANV LIKE 'TP%' THEN 
        EXECUTE IMMEDIATE 'GRANT TRUONGPHONG TO ' || MANV;
        ELSIF MANV LIKE 'QL%' THEN 
        EXECUTE IMMEDIATE 'GRANT QUANLY TO ' || MANV;
        END IF;
        
        EXECUTE IMMEDIATE 'INSERT INTO BAP.TAIKHOAN_PH2(MATK, PASS) VALUES (:MANV , ''PH123'')' USING MANV;
END CREATE_USER; 
/

---------------------------------------------------------------------
-- MA HOA 
BEGIN
   EXECUTE IMMEDIATE 'DROP TRIGGER ENCRYPT_NHANVIEN';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -4080 THEN
      RAISE; 
      END IF;
END;
/
CREATE OR REPLACE TRIGGER ENCRYPT_NHANVIEN 
BEFORE INSERT OR UPDATE ON NHANVIEN 
FOR EACH ROW
DECLARE
  KEY_NV RAW(32):= UTL_RAW.CAST_TO_RAW ('NHOM7_SECRETENCRYPTKEY');
  EN_LUONG RAW(2000);
  EN_PHUCAP RAW(2000);
BEGIN
  IF INSERTING OR UPDATING('LUONG') THEN
    IF :NEW.LUONG IS NOT NULL AND :NEW.LUONG <> 0 THEN
      EN_LUONG := DBMS_CRYPTO.ENCRYPT(
                    SRC => UTL_RAW.CAST_TO_RAW(:NEW.LUONG),
                    TYP => DBMS_CRYPTO.DES_CBC_PKCS5,
                    KEY => KEY_NV
                   );
      :NEW.LUONG := UTL_RAW.CAST_TO_VARCHAR2(EN_LUONG);
    ELSE
      :NEW.LUONG := NULL;
    END IF;
  END IF;

  IF INSERTING OR UPDATING('PHUCAP') THEN
    IF :NEW.PHUCAP IS NOT NULL AND :NEW.PHUCAP <> 0 THEN
      EN_PHUCAP := DBMS_CRYPTO.ENCRYPT(
                    SRC => UTL_RAW.CAST_TO_RAW(:NEW.PHUCAP),
                    TYP => DBMS_CRYPTO.DES_CBC_PKCS5,
                    KEY => KEY_NV
                   );
      :NEW.PHUCAP := UTL_RAW.CAST_TO_VARCHAR2 (EN_PHUCAP);
    ELSE
      :NEW.PHUCAP := NULL;
    END IF;
  END IF;
END;
/


-- GIAI MA 
BEGIN
   EXECUTE IMMEDIATE 'DROP FUNCTION DECRYPT_NHANVIEN';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -4043 THEN
      RAISE; 
      END IF;
END;
/

CREATE OR REPLACE FUNCTION DECRYPT_NHANVIEN (ENCRYPTED_DATA IN VARCHAR2)
RETURN VARCHAR2
AS
    KEY_NV RAW(32):= UTL_RAW.CAST_TO_RAW ('NHOM7_SECRETENCRYPTKEY');
    DECRYPTED_DATA RAW(2000);
BEGIN
    IF ENCRYPTED_DATA IS NOT NULL THEN
        DECRYPTED_DATA := DBMS_CRYPTO.DECRYPT(
            SRC => UTL_RAW.CAST_TO_RAW(ENCRYPTED_DATA),
            TYP => DBMS_CRYPTO.DES_CBC_PKCS5,
            KEY => KEY_NV );
        RETURN UTL_RAW.CAST_TO_VARCHAR2(DECRYPTED_DATA);
    ELSE
        RETURN NULL;
    END IF;
END;
/

--SELECT * FROM NHANVIEN;
--SELECT * FROM TAIKHOAN_PH2;
--UPDATE NHANVIEN SET LUONG = 100000 WHERE MANV = 'NS1';

--NHAP LIEU
INSERT INTO NHANVIEN VALUES ('NV1', 'AN', 'NAM', TO_DATE('20-11-1988','DD-MM-YYYY'), '2 MGJ', 0126644786, '10000', '2000', 'NHANVIEN', null, null);
EXEC CREATE_USER('NV1');

INSERT INTO NHANVIEN VALUES ('NV2', 'SDF', 'NU', TO_DATE('06-01-2000','DD-MM-YYYY'), '25 LHK', 0156496465, '15000', '2200', 'NHANVIEN', null, null);
INSERT INTO NHANVIEN VALUES ('NV3', 'GFD', 'NAM', TO_DATE('29-11-1997','DD-MM-YYYY'), '6 JG', 0784562123, '17000', '2300', 'NHANVIEN', null, null);
INSERT INTO NHANVIEN VALUES ('NV4', 'DF', 'NU', TO_DATE('10-03-1997','DD-MM-YYYY'), '68 JGI', 0758461302, '18000', '2100', 'NHANVIEN', null, null);
INSERT INTO NHANVIEN VALUES ('NV5', 'HT', 'NU', TO_DATE('19-09-1980','DD-MM-YYYY'), '98 FNF', 0785432591, '19000', '22300', 'NHANVIEN', null, null);

INSERT INTO NHANVIEN VALUES ('QL1', 'JH', 'NU', TO_DATE('06-03-1990','DD-MM-YYYY'), '45 DFG', 0125478542, '10500', '4000', 'QUANLY', null, null);
EXEC CREATE_USER('QL1');
INSERT INTO NHANVIEN VALUES ('QL2', 'HHF', 'NAM', TO_DATE('10-12-1983','DD-MM-YYYY'), '17 DT', 0365478521, '14000', '4500', 'QUANLY', null, null);
INSERT INTO NHANVIEN VALUES ('QL3', 'ET', 'NU', TO_DATE('27-03-1991','DD-MM-YYYY'), '8 DVF', 0654265897, '10700', '5000', 'QUANLY', null, null);
INSERT INTO NHANVIEN VALUES ('QL4', 'GF', 'NU', TO_DATE('30-11-1988','DD-MM-YYYY'), '65 DFG', 0125474521, '14000', '6000', 'QUANLY', null, null);
INSERT INTO NHANVIEN VALUES ('QL5', 'TY', 'NAM', TO_DATE('10-11-1982','DD-MM-YYYY'), '88 FGF', 0587854695, '12000', '7000', 'QUANLY', null, null);

INSERT INTO NHANVIEN VALUES ('TP1', 'NZB', 'NU', TO_DATE('26-01-1984','DD-MM-YYYY'), '56 DEF', 0325698425, '20800', '2500', 'TRUONGPHONG', null, null);
EXEC CREATE_USER('TP1');
INSERT INTO NHANVIEN VALUES ('TP2', 'C', 'NAM', TO_DATE('20-05-1988','DD-MM-YYYY'), '11 NBH', 0658475912, '24000', '2200', 'TRUONGPHONG', null, null);
INSERT INTO NHANVIEN VALUES ('TP3', 'NXG', 'NU', TO_DATE('18-04-1982','DD-MM-YYYY'), '32 VCX', 0315698425, '25000', '2600', 'TRUONGPHONG', null, null);
INSERT INTO NHANVIEN VALUES ('TP4', 'SFJ', 'NU', TO_DATE('13-07-1992','DD-MM-YYYY'), '42 MNB', 0315469875, '20500', '2700', 'TRUONGPHONG', null, null);
INSERT INTO NHANVIEN VALUES ('TP5', 'BC', 'NAM', TO_DATE('24-07-1991','DD-MM-YYYY'), '56 NBJ', 0321458756, '20200', '2800', 'TRUONGPHONG', null, null);
INSERT INTO NHANVIEN VALUES ('TP6', 'YU', 'NAM', TO_DATE('11-03-1988','DD-MM-YYYY'), '103 BVY', 0214521698, '22000', '2900', 'TRUONGPHONG', null, null);
INSERT INTO NHANVIEN VALUES ('TP7', 'DYBT', 'NAM', TO_DATE('04-03-1981','DD-MM-YYYY'), '402 TDG', 0165478526, '22500', '2300', 'TRUONGPHONG', null, null);
INSERT INTO NHANVIEN VALUES ('TP8', 'BHJ', 'NAM', TO_DATE('02-06-1995','DD-MM-YYYY'), '36 IHU', 0698546213, '27000', '2800', 'TRUONGPHONG', null, null);

INSERT INTO NHANVIEN VALUES ('TC1', 'DN', 'NAM', TO_DATE('17-10-1984','DD-MM-YYYY'), '25 TNU', 0231546987, '20400', '2000', 'TAICHINH', null, null);
EXEC CREATE_USER('TC1');
INSERT INTO NHANVIEN VALUES ('TC2', 'HKJ', 'NU', TO_DATE('15-06-1988','DD-MM-YYYY'), '6 NGC', 0213654545, '26000', '2000', 'TAICHINH', null, null);
INSERT INTO NHANVIEN VALUES ('TC3', 'MV', 'NAM', TO_DATE('01-01-1986','DD-MM-YYYY'), '100 PJI', 0625413687, '29000', '2000', 'TAICHINH', null, null);
INSERT INTO NHANVIEN VALUES ('TC4', 'GFS', 'NU', TO_DATE('10-02-1988','DD-MM-YYYY'), '130 XRG', 0215478965, '26000', '2000', 'TAICHINH', null, null);
INSERT INTO NHANVIEN VALUES ('TC5', 'GK', 'NU', TO_DATE('20-07-1993','DD-MM-YYYY'), '301 ZDR', 0201253026, '20800', '2000', 'TAICHINH', null, null);

INSERT INTO NHANVIEN VALUES ('NS1', 'K', 'NU', TO_DATE('18-05-1985','DD-MM-YYYY'), '1 MNO', 0603214520, '2500', '2000', 'NHANSU', null, null);
EXEC CREATE_USER('NS1');
INSERT INTO NHANVIEN VALUES ('NS2', 'UYT', 'NAM', TO_DATE('09-09-1995','DD-MM-YYYY'), '19 XYZ', 0303256987, '24520', '2000', 'NHANSU', null, null);
INSERT INTO NHANVIEN VALUES ('NS3', 'LG', 'NAM', TO_DATE('07-02-1991','DD-MM-YYYY'), '62 JVR', 0301547852, '2120', '2000', 'NHANSU', null, null);
INSERT INTO NHANVIEN VALUES ('NS4', 'BN', 'NAM', TO_DATE('16-08-1981','DD-MM-YYYY'), '78 ZAS', 0809210546, '2500', '2000', 'NHANSU', null, null);
INSERT INTO NHANVIEN VALUES ('NS5', 'JO', 'NU', TO_DATE('12-07-1984','DD-MM-YYYY'), '8 IN', 0664512087, '2300', '2000', 'NHANSU', null, null);

INSERT INTO NHANVIEN VALUES ('TDA1', 'VXC', 'NAM', TO_DATE('09-01-1991','DD-MM-YYYY'), '7 TUV', 0954025651, '2800', '2000', 'TRUONGDOAN', null, null);
EXEC CREATE_USER('TDA1');
INSERT INTO NHANVIEN VALUES ('TDA2', 'XVC', 'NU', TO_DATE('18-12-1995','DD-MM-YYYY'), '11 XYZ', 0948506124, '24500', '2000', 'TRUONGDOAN', null, null);
INSERT INTO NHANVIEN VALUES ('TDA3', 'NMV', 'NAM', TO_DATE('01-06-1989','DD-MM-YYYY'), '32 QRS', 0301245782, '24330', '2000', 'TRUONGDOAN', null, null);

INSERT INTO NHANVIEN VALUES ('GD1', 'ZC', 'NAM', TO_DATE('23-02-1989','DD-MM-YYYY'), '23 BCD', 0948516406, '244500', '20000', 'GIAMDOC', null, null);
EXEC CREATE_USER('GD1');
INSERT INTO NHANVIEN VALUES ('GD2', 'ZCX', 'NU', TO_DATE('28-10-1989','DD-MM-YYYY'), '15 TUV', 0652032147, '278000', '28000', 'GIAMDOC', null, null);
INSERT INTO NHANVIEN VALUES ('GD3', 'VX', 'NAM', TO_DATE('27-10-1981','DD-MM-YYYY'), '13 JQK', 0854201320, '264000', '28000', 'GIAMDOC', null, null);
INSERT INTO NHANVIEN VALUES ('GD4', 'DA', 'NAM', TO_DATE('08-04-1986','DD-MM-YYYY'), '36 BCH', 0312450645, '265000', '27000', 'GIAMDOC', null, null);
INSERT INTO NHANVIEN VALUES ('GD5', 'RT', 'NAM', TO_DATE('27-03-1982','DD-MM-YYYY'), '12 NGN', 0615427849, '254000', '29000', 'GIAMDOC', null, null);

INSERT INTO PHONGBAN VALUES ('01', 'XYZ', 'TP1');
INSERT INTO PHONGBAN VALUES ('02', 'TUV', 'TP2');
INSERT INTO PHONGBAN VALUES ('03', 'ABC', 'TP3');
INSERT INTO PHONGBAN VALUES ('04', 'DEF', 'TP4');
INSERT INTO PHONGBAN VALUES ('05', 'GHI', 'TP5');
INSERT INTO PHONGBAN VALUES ('06', 'MNO', 'TP6');
INSERT INTO PHONGBAN VALUES ('07', 'JKL', 'TP7');
INSERT INTO PHONGBAN VALUES ('08', 'QRS', 'TP8');

UPDATE NHANVIEN
SET MANQL = 'QL5'
WHERE MANV = 'NV1';

UPDATE NHANVIEN
SET PHG = '08'
WHERE MANV = 'NS1';

UPDATE NHANVIEN
SET PHG = '01'
WHERE MANV = 'NV1';

UPDATE NHANVIEN
SET MANQL = 'QL1'
WHERE MANV = 'NV1';

UPDATE NHANVIEN
SET PHG = '01'
WHERE MANV = 'NV2';

UPDATE NHANVIEN
SET MANQL = 'QL2'
WHERE MANV = 'NV2';

UPDATE NHANVIEN
SET PHG = '02'
WHERE MANV = 'NV3';

UPDATE NHANVIEN
SET MANQL = 'QL3'
WHERE MANV = 'NV3';

UPDATE NHANVIEN
SET PHG = '03'
WHERE MANV = 'NV4';

UPDATE NHANVIEN
SET MANQL = 'QL4'
WHERE MANV = 'NV4';

UPDATE NHANVIEN
SET PHG = '05'
WHERE MANV = 'NV5';

UPDATE NHANVIEN
SET MANQL = 'QL5'
WHERE MANV = 'NV5';

INSERT INTO DEAN VALUES ('2201', 'ABCD', '25-Dec-2022', '01');
INSERT INTO DEAN VALUES ('2202', 'EFGH', '25-Dec-2022', '01');

INSERT INTO PHANCONG VALUES ('NS1', '2201', '01-Apr-2023');
INSERT INTO PHANCONG VALUES ('TP1', '2201', '02-Apr-2023');
INSERT INTO PHANCONG VALUES ('NV1', '2202', '02-Apr-2023');
